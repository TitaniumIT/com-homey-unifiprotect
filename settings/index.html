<!doctype html>
<html>

<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
</head>

<body>
    <!-- Title -->
    <h1 data-i18n="settings.title"></h1>

    <!-- Instruction -->
    <p data-i18n="settings.instruction"></p>

    <!-- NVR -->
    <fieldset>
        <legend data-i18n="settings.nvr"></legend>

        <!-- IP address -->
        <div class="field row">
            <label for="txt_nvrip" data-i18n="settings.nvrip"></label>
            <input id="txt_nvrip" type="text" value="" />
        </div>

      <!-- Use proxy client -->
      <div class="field row">
        <label for="txt_nvruseproxy" data-i18n="settings.nvruseproxy"></label>
        <input id="txt_nvruseproxy" type="checkbox" />
      </div>

    </fieldset>

    <!-- Credentials -->
    <fieldset>
        <legend data-i18n="settings.credentials"></legend>

        <!-- Username -->
        <div class="field row">
            <label for="txt_username" data-i18n="settings.username"></label>
            <input id="txt_username" type="text" value="" />
        </div>

        <!-- Password -->
        <div class="field row">
            <label for="txt_password" data-i18n="settings.password"></label>
            <input id="txt_password" type="password" value="" />
        </div>
    </fieldset>

    <!-- Apply button -->
    <div class="field row">
        <button id="btn_apply" class="right" data-i18n="settings.apply"></button>
    </div>

    <script type="text/javascript">
        var txtNvrIp = document.getElementById('txt_nvrip');
        var txtUsername = document.getElementById('txt_username');
        var txtPassword = document.getElementById('txt_password');
        var txtNvrUseProxy = (document.getElementById('txt_nvruseproxy').checked ? 'true' : 'false');
        var btnApply = document.getElementById('btn_apply');

        function onHomeyReady(Homey) {
            const readSettings = () => {
                Homey.get('ufp:nvrip', (error, nvrip) => {
                    if (error) return Homey.alert(error);

                    if (nvrip) {
                        txtNvrIp.value = nvrip;
                    } else {
                        console.warn('[SETTINGS] Could not read UniFi Cloud Key IP address.');
                    }
                });

                Homey.get('ufp:credentials', (error, credentials) => {
                    if (error) return Homey.alert(error);

                    if (credentials) {
                        txtUsername.value = credentials.username;
                        txtPassword.value = credentials.password;
                    } else {
                        console.warn('[SETTINGS] Could not read credentials.');
                    }
                });
            }

            const saveSettings = () => {
              console.log('saveSettings: ' + txtNvrUseProxy);
              Homey.api('POST', '/settings/validate', { 'hostname': txtNvrIp.value, 'useProxy': txtNvrUseProxy, 'username': txtUsername.value, 'password': txtPassword.value }, function( err, result ) {
                if( err ) return Homey.alert(err);
                Homey.set('ufp:nvrip', txtNvrIp.value, (error, result) => {
                  if (error) return Homey.alert(error);
                  console.log('[SETTINGS] UniFi Cloud Key IP address saved.');
                });

                Homey.set('ufp:useproxy', txtNvrUseProxy, (error, result) => {
                  if (error) return Homey.alert(error);
                  console.log('[SETTINGS] UniFi Cloud Key Use Proxy Key saved.');
                });

                const credentials = {
                  'username': txtUsername.value,
                  'password': txtPassword.value
                };

                Homey.set('ufp:credentials', credentials, (error, result) => {
                  if (error) return Homey.alert(error);
                  console.log('[SETTINGS] credentials saved.');
                });
                Homey.alert(Homey.__('settings.saved'), 'info');
              });
            }

            btnApply.addEventListener('click', e => {
                saveSettings();
            });

            readSettings();
            Homey.ready();
        }
    </script>
</body>

</html>
